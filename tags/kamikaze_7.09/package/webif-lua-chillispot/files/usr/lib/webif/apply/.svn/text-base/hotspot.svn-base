#!/usr/bin/lua
--------------------------------------------------------------------------------
-- freeradius apply handler
-- Author(s) [in order of work date]:
--       Fabián Omar Franzotti
--         
-- Configuration files referenced:
--    freeradius
--   
--
--------------------------------------------------------------------------------
print ("Committing Chillispot".."<br>")
os.execute("uci commit hotspot")
print("Checking freeradius installation".."<br>")
local write_file
if io.exists("/usr/share/freeradius/dictionary") then
  local dict = io.totable("/usr/share/freeradius/dictionary",true)
  print("Updating /usr/share/freeradius/dictionary".."<br>")
  if dict[1] ~= "$INCLUDE dictionary.chillispot" then
    table.insert(dict,1,"$INCLUDE dictionary.chillispot")
  end
  write_file = io.open("/usr/share/freeradius/dictionary","w")
  write_file:write(table.concat(dict,'\n'))
  write_file:close()
end
init_file = [[#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org
START=50

RUN_D=/var/run
PID_F=$RUN_D/chilli.pid

start() {
	/usr/sbin/chilli
  /etc/init.d/firewall restart
}

stop() {
	[ -f $PID_F ] && kill $(cat $PID_F) >/dev/null 2>&1
}

]]
print ("Writing init file /etc/init.d/chilli".."<br>")
write_file = io.open("/etc/init.d/chilli","w")
write_file:write(init_file)
write_file:close()
print ("Writing configuration file /etc/chilli.conf".."<br>")
local hotspot = uciClass.new("hotspot")
chilli = hotspot.chilli
local conf_file = "## this file is automatically generated\n\n"

for i=1, #chilli do
  for k,v in pairs(chilli[i].values) do
    if k == "debug"
    or k == "macauth"
    or k == "uamanydns"
    or k == "coanoipcheck"
    or k == "acctupdate"
    or k == "fg"
    or k == "eapolenable" then
      if tonumber(v) == 1 then
        conf_file = conf_file .. k .. "\n"
      end
    else
      conf_file = conf_file .. k .. " " .. v .. "\n"
    end
  end
end
write_file = io.open("/etc/chilli.conf","w")
write_file:write(conf_file)
write_file:close()

__RESTART["Chillispot"] = {}
__RESTART["Chillispot"]["pkg"] = "hotspot"
__RESTART["Chillispot"]["cfg"] = "service"
__RESTART["Chillispot"]["opt"] = "enable"
__RESTART["Chillispot"]["init"] = "/etc/init.d/chilli"
